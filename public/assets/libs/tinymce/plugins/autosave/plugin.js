!function(){"use strict";var e,t=tinymce.util.Tools.resolve("tinymce.PluginManager");let hasProto=(e,t,r)=>{var a;return!!r(e,t.prototype)||(null===(a=e.constructor)||void 0===a?void 0:a.name)===t.name},typeOf=e=>{let t=typeof e;return null===e?"null":"object"===t&&Array.isArray(e)?"array":"object"===t&&hasProto(e,String,(e,t)=>t.isPrototypeOf(e))?"string":t},isString=e=>"string"===typeOf(e),r=(e=void 0,t=>e===t);var a=tinymce.util.Tools.resolve("tinymce.util.Delay"),o=tinymce.util.Tools.resolve("tinymce.util.LocalStorage"),s=tinymce.util.Tools.resolve("tinymce.util.Tools");let fireRestoreDraft=e=>e.dispatch("RestoreDraft"),fireStoreDraft=e=>e.dispatch("StoreDraft"),fireRemoveDraft=e=>e.dispatch("RemoveDraft"),parse=e=>{let t=/^(\d+)([ms]?)$/.exec(e);return(t&&t[2]?({s:1e3,m:6e4})[t[2]]:1)*parseInt(e,10)},option=e=>t=>t.options.get(e),register$1=e=>{let t=e.options.register,timeProcessor=e=>{let t=isString(e);return t?{value:parse(e),valid:t}:{valid:!1,message:"Must be a string."}};t("autosave_ask_before_unload",{processor:"boolean",default:!0}),t("autosave_prefix",{processor:"string",default:"tinymce-autosave-{path}{query}{hash}-{id}-"}),t("autosave_restore_when_empty",{processor:"boolean",default:!1}),t("autosave_interval",{processor:timeProcessor,default:"30s"}),t("autosave_retention",{processor:timeProcessor,default:"20m"})},i=option("autosave_ask_before_unload"),n=option("autosave_restore_when_empty"),l=option("autosave_interval"),f=option("autosave_retention"),getAutoSavePrefix=e=>{let t=document.location;return e.options.get("autosave_prefix").replace(/{path}/g,t.pathname).replace(/{query}/g,t.search).replace(/{hash}/g,t.hash).replace(/{id}/g,e.id)},isEmpty=(e,t)=>{if(r(t))return e.dom.isEmpty(e.getBody());{let r=s.trim(t);if(""===r)return!0;{let t=new DOMParser().parseFromString(r,"text/html");return e.dom.isEmpty(t)}}},hasDraft=e=>{var t;let r=parseInt(null!==(t=o.getItem(getAutoSavePrefix(e)+"time"))&&void 0!==t?t:"0",10)||0;return!(new Date().getTime()-r>f(e))||(removeDraft(e,!1),!1)},removeDraft=(e,t)=>{let r=getAutoSavePrefix(e);o.removeItem(r+"draft"),o.removeItem(r+"time"),!1!==t&&fireRemoveDraft(e)},storeDraft=e=>{let t=getAutoSavePrefix(e);!isEmpty(e)&&e.isDirty()&&(o.setItem(t+"draft",e.getContent({format:"raw",no_events:!0})),o.setItem(t+"time",new Date().getTime().toString()),fireStoreDraft(e))},restoreDraft=e=>{var t;let r=getAutoSavePrefix(e);hasDraft(e)&&(e.setContent(null!==(t=o.getItem(r+"draft"))&&void 0!==t?t:"",{format:"raw"}),fireRestoreDraft(e))},startStoreDraft=e=>{let t=l(e);a.setEditorInterval(e,()=>{storeDraft(e)},t)},restoreLastDraft=e=>{e.undoManager.transact(()=>{restoreDraft(e),removeDraft(e)}),e.focus()},get=e=>({hasDraft:()=>hasDraft(e),storeDraft:()=>storeDraft(e),restoreDraft:()=>restoreDraft(e),removeDraft:t=>removeDraft(e,t),isEmpty:t=>isEmpty(e,t)});var u=tinymce.util.Tools.resolve("tinymce.EditorManager");let setup=e=>{e.editorManager.on("BeforeUnload",e=>{let t;s.each(u.get(),e=>{e.plugins.autosave&&e.plugins.autosave.storeDraft(),!t&&e.isDirty()&&i(e)&&(t=e.translate("You have unsaved changes are you sure you want to navigate away?"))}),t&&(e.preventDefault(),e.returnValue=t)})},makeSetupHandler=e=>t=>{t.setEnabled(hasDraft(e));let editorEventCallback=()=>t.setEnabled(hasDraft(e));return e.on("StoreDraft RestoreDraft RemoveDraft",editorEventCallback),()=>e.off("StoreDraft RestoreDraft RemoveDraft",editorEventCallback)},register=e=>{startStoreDraft(e);let onAction=()=>{restoreLastDraft(e)};e.ui.registry.addButton("restoredraft",{tooltip:"Restore last draft",icon:"restore-draft",onAction,onSetup:makeSetupHandler(e)}),e.ui.registry.addMenuItem("restoredraft",{text:"Restore last draft",icon:"restore-draft",onAction,onSetup:makeSetupHandler(e)})};t.add("autosave",e=>(register$1(e),setup(e),register(e),e.on("init",()=>{n(e)&&e.dom.isEmpty(e.getBody())&&restoreDraft(e)}),get(e)))}();